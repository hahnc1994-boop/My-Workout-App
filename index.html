<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gym Track Pro - Calendar Edition</title>
    <style>
        :root { --bg: #000; --card: #1c1c1e; --primary: #0a84ff; --text: #fff; --accent: #32d74b; --gold: #ffd700; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; padding-bottom: 100px; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid var(--primary); }
        input { background: #2c2c2e; border: none; color: white; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box; }
        
        /* FOOTER NAV */
        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: #111; display: grid; grid-template-columns: 1fr 1fr 1fr; border-top: 1px solid #333; z-index: 100; }
        .footer button { background: none; border: none; color: white; padding: 20px; font-weight: bold; font-size: 0.8rem; }
        
        /* PANEL LOGIC */
        .panel { position: fixed; top: 100%; left: 0; width: 100%; height: 90%; background: #1c1c1e; transition: top 0.3s ease; z-index: 200; overflow-y: auto; padding: 20px; box-sizing: border-box; border-radius: 20px 20px 0 0; }
        .panel.open { top: 10%; }

        /* CALENDAR STYLING */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 20px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: #333; border-radius: 8px; font-size: 0.8rem; font-weight: bold; }
        .cal-has-data { background: var(--primary); color: white; border: 2px solid #555; }
        .cal-selected { background: var(--accent) !important; color: black !important; }
        
        .history-detail { background: #2c2c2e; padding: 15px; border-radius: 10px; margin-top: 10px; }
        .set-row { display: grid; grid-template-columns: 1fr 1fr 1fr; padding: 5px 0; border-bottom: 1px solid #444; font-size: 0.8rem; }
    </style>
</head>
<body>

<div id="main-view">
    <h2 style="color:var(--primary)">Log Workout</h2>
    <div class="card">
        <span style="font-size:0.7rem; color:#8e8e93;">SELECT DATE</span>
        <input type="date" id="main-date">
    </div>
    <div id="exercise-list"></div>
    <button onclick="addExercise()" style="width:100%; padding:15px; background:#1c1c1e; color:white; border:2px dashed #444; border-radius:12px; font-weight:bold;">+ Add Exercise</button>
</div>

<div id="history-panel" class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="color:var(--primary)">History Calendar</h2>
        <button onclick="closePanels()" style="background:none; border:none; color:var(--primary); font-weight:bold;">DONE</button>
    </div>
    
    <div id="calendar-view" class="calendar-grid"></div>
    
    <div id="history-results">
        <p style="text-align:center; color:#8e8e93;">Select a blue date above to see your lifts.</p>
    </div>
</div>

<div class="footer">
    <button onclick="openHistory()">HISTORY</button>
    <button onclick="closePanels()">LOG</button>
    <button onclick="saveWorkout()" style="color:var(--accent)">SAVE</button>
</div>

<script>
    const url = "https://script.google.com/macros/s/AKfycbygcgrTFkyiJKUjB2xKnMDQILdD8rIwHSqMtpO1kaY6OFLX4PCvqpSdfx81jXVswWko/exec"; 
    let fullData = [];
    document.getElementById('main-date').valueAsDate = new Date();

    async function fetchData() {
        const res = await fetch(url);
        fullData = await res.json();
        renderCalendar();
    }

    function renderCalendar() {
        const grid = document.getElementById('calendar-view');
        grid.innerHTML = "";
        
        // Get last 28 days for the calendar
        const today = new Date();
        for (let i = 27; i >= 0; i--) {
            const d = new Date();
            d.setDate(today.getDate() - i);
            const dStr = d.toISOString().split('T')[0];
            
            const hasData = fullData.some(item => item.date === dStr);
            const dayDiv = document.createElement('div');
            dayDiv.className = `cal-day ${hasData ? 'cal-has-data' : ''}`;
            dayDiv.innerText = d.getDate();
            dayDiv.onclick = () => showHistoryForDate(dStr, dayDiv);
            grid.appendChild(dayDiv);
        }
    }

    function showHistoryForDate(dateStr, element) {
        document.querySelectorAll('.cal-day').forEach(el => el.classList.remove('cal-selected'));
        element.classList.add('cal-selected');
        
        const dayLogs = fullData.filter(item => item.date === dateStr);
        const results = document.getElementById('history-results');
        
        if (dayLogs.length === 0) {
            results.innerHTML = `<p style="text-align:center; margin-top:20px;">No data for ${dateStr}</p>`;
            return;
        }

        let html = `<h3 style="margin-bottom:5px;">${dateStr}</h3>`;
        // Group exercises
        const grouped = dayLogs.reduce((acc, curr) => {
            if (!acc[curr.exercise]) acc[curr.exercise] = [];
            acc[curr.exercise].push(curr);
            return acc;
        }, {});

        for (const ex in grouped) {
            html += `<div class="history-detail">
                        <strong style="color:var(--primary)">${ex}</strong>
                        <div class="set-row" style="font-weight:bold; border-bottom:2px solid #555;"><span>Set</span><span>Lbs</span><span>Reps</span></div>
                        ${grouped[ex].map((s, i) => `<div class="set-row"><span>${i+1}</span><span>${s.weight || '-'}</span><span>${s.reps || s.duration || '-'}</span></div>`).join('')}
                    </div>`;
        }
        results.innerHTML = html;
    }

    function addExercise(name = "") {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<input type="text" placeholder="Exercise Name" class="ex-name" value="${name}" style="font-weight:bold; color:var(--primary); background:none; margin-bottom:10px;">
                        <div class="sets">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                <input type="number" placeholder="Lbs" class="ex-weight">
                                <input type="number" placeholder="Reps" class="ex-reps">
                            </div>
                        </div>`;
        document.getElementById('exercise-list').appendChild(div);
    }

    async function saveWorkout() {
        const date = document.getElementById('main-date').value;
        const entries = [];
        document.querySelectorAll('#exercise-list .card').forEach(card => {
            entries.push({
                date: date,
                exercise: card.querySelector('.ex-name').value,
                weight: card.querySelector('.ex-weight').value,
                reps: card.querySelector('.ex-reps').value
            });
        });
        await fetch(url, { method: 'POST', mode: 'no-cors', body: JSON.stringify(entries) });
        alert("Saved!");
        fetchData();
    }

    function openHistory() { document.getElementById('history-panel').classList.add('open'); fetchData(); }
    function closePanels() { document.querySelectorAll('.panel').forEach(p => p.classList.remove('open')); }

    fetchData();
</script>
</body>
</html>
